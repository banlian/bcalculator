<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8">
    <title>æ•°æ®ç»Ÿè®¡å¯è§†åŒ–</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .input-container {
            margin-bottom: 20px;
        }

        textarea {
            width: 100%;
            height: 200px;
            margin-bottom: 10px;
            padding: 10px;
            font-size: 14px;
        }

        button {
            padding: 10px 20px;
            font-size: 16px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        button:hover {
            background-color: #45a049;
        }

        #monthlyTotals {
            margin: 20px 0;
            padding: 15px;
            background-color: #f5f5f5;
            border-radius: 4px;
        }

        #chartContainer {
            margin-top: 20px;
        }
    </style>
</head>

<body>
    <h1>æ•°æ®ç»Ÿè®¡å¯è§†åŒ–</h1>

    <div class="input-container">
        <textarea id="dataInput" placeholder="è¯·è¾“å…¥æ•°æ®ï¼Œæ ¼å¼å¦‚ï¼š
4æœˆ7å·:8550ğŸ’°
4æœˆ8å·:2130ğŸ’°
..."></textarea>
        <button onclick="processAndDisplay()">ç”Ÿæˆç»Ÿè®¡å›¾</button>
    </div>

    <div id="monthlyTotals"></div>
    <div id="chartContainer"></div>

    <script>
        // å¤„ç†æ•°æ®
        function processData(rawData) {
            // å°†ä¸­æ–‡å†’å·æ›¿æ¢ä¸ºè‹±æ–‡å†’å·
            const normalizedData = rawData.replace(/ï¼š/g, ':');
            const lines = normalizedData.split('\n');
            const processedData = [];
            const monthlyTotals = {};
            let totalAmount = 0;

            lines.forEach(line => {
                // ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…æ—¥æœŸå’Œæ•°å­—
                const match = line.match(/(\d+æœˆ\d+å·)[^\d]*([^\n]*)/);
                if (match) {
                    const date = match[1];
                    let value = match[2].trim();
                    // å¦‚æœå€¼ä¸æ˜¯çº¯æ•°å­—ï¼Œåˆ™æ›¿æ¢ä¸º0
                    const numericValue = /^\d+$/.test(value) ? parseInt(value) : 0;

                    // æå–æœˆä»½ï¼ˆä¾‹å¦‚ä»"4æœˆ7å·"ä¸­æå–"4æœˆ"ï¼‰
                    const month = date.match(/(\d+)æœˆ/)[0];

                    // ç´¯åŠ æœˆåº¦æ€»é¢
                    monthlyTotals[month] = (monthlyTotals[month] || 0) + numericValue;

                    processedData.push({
                        date: date,
                        value: numericValue
                    });

                    totalAmount += numericValue;
                }
            });

            return {
                dailyData: processedData,
                monthlyTotals: monthlyTotals,
                totalAmount: totalAmount
            };
        }

        // ç”Ÿæˆå›¾è¡¨
        function generateChart(data) {
            // æ¸…é™¤æ—§çš„å›¾è¡¨
            const chartContainer = document.getElementById('chartContainer');
            chartContainer.innerHTML = '';

            const canvas = document.createElement('canvas');
            canvas.width = 1000;
            canvas.height = 500;
            chartContainer.appendChild(canvas);

            // åˆ¤æ–­æ˜¯å¦ä¸ºæ³•å®šå‡æœŸ
            function isHoliday(month, day) {
                const holidays = {
                    '1': [1], // å…ƒæ—¦
                    '5': [1, 2, 3], // åŠ³åŠ¨èŠ‚
                    '10': [1, 2, 3, 4, 5, 6, 7], // å›½åº†èŠ‚
                };

                // å†œå†èŠ‚æ—¥ï¼ˆä½¿ç”¨å…¬å†æ—¥æœŸï¼‰
                const lunarHolidays = {
                    '2': [10], // æ˜¥èŠ‚ï¼ˆç¤ºä¾‹æ—¥æœŸï¼Œéœ€è¦æ ¹æ®å®é™…å†œå†è°ƒæ•´ï¼‰
                    '4': [5], // æ¸…æ˜èŠ‚
                    '6': [10], // ç«¯åˆèŠ‚ï¼ˆç¤ºä¾‹æ—¥æœŸï¼Œéœ€è¦æ ¹æ®å®é™…å†œå†è°ƒæ•´ï¼‰
                    '9': [15], // ä¸­ç§‹èŠ‚ï¼ˆç¤ºä¾‹æ—¥æœŸï¼Œéœ€è¦æ ¹æ®å®é™…å†œå†è°ƒæ•´ï¼‰
                };

                return (holidays[month] && holidays[month].includes(day)) ||
                    (lunarHolidays[month] && lunarHolidays[month].includes(day));
            }

            // åˆ¤æ–­æ˜¯å¦ä¸ºå‘¨æœ«æˆ–å‡æœŸ
            function isWeekendOrHoliday(dateStr) {
                const match = dateStr.match(/(\d+)æœˆ(\d+)å·/);
                if (match) {
                    const month = parseInt(match[1]);
                    const day = parseInt(match[2]);
                    const date = new Date(2024, month - 1, day);
                    const dayOfWeek = date.getDay();
                    return dayOfWeek === 5 || dayOfWeek === 6 || isHoliday(month, day);
                }
                return false;
            }

            const ctx = canvas.getContext('2d');

            // è®¡ç®—å¹³å‡å€¼
            const average = data.dailyData.reduce((sum, item) => sum + item.value, 0) / data.dailyData.length;

            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.dailyData.map(item => item.date),
                    datasets: [
                        {
                            label: 'æ¯æ—¥é‡‘é¢',
                            data: data.dailyData.map(item => item.value),
                            backgroundColor: data.dailyData.map(item => {
                                const isSpecialDay = isWeekendOrHoliday(item.date);
                                return isSpecialDay ? 'rgba(255, 99, 132, 0.5)' : 'rgba(54, 162, 235, 0.5)';
                            }),
                            borderColor: data.dailyData.map(item =>
                                isWeekendOrHoliday(item.date) ? 'rgba(255, 99, 132, 1)' : 'rgba(54, 162, 235, 1)'
                            ),
                            borderWidth: 1,
                            order: 2
                        },
                        {
                            label: 'å¹³å‡å€¼',
                            data: data.dailyData.map(() => average),
                            type: 'line',
                            borderColor: 'rgba(255, 11, 11, 1)',
                            borderWidth: 2,
                            borderDash: [5, 5],
                            fill: false,
                            pointRadius: 0,
                            order: 1
                        }
                    ]
                },
                options: {
                    responsive: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'é‡‘é¢ (å…ƒ)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'æ—¥æœŸ'
                            }
                        }
                    }
                }
            });

            // æ˜¾ç¤ºæœˆåº¦æ€»è®¡
            const monthlyTotalsDiv = document.getElementById('monthlyTotals');
            monthlyTotalsDiv.innerHTML = '<h2>æœˆåº¦æ€»è®¡</h2>';
            let grandTotal = 0;
            for (const [month, total] of Object.entries(data.monthlyTotals)) {
                monthlyTotalsDiv.innerHTML += `<p>${month}: ${total.toLocaleString()} å…ƒ</p>`;
                grandTotal += total;
            }
            monthlyTotalsDiv.innerHTML += `<h3>æ€»è®¡: ${grandTotal.toLocaleString()} å…ƒ</h3>`;
        }

        // å¤„ç†å¹¶æ˜¾ç¤ºæ•°æ®
        function processAndDisplay() {
            const rawData = document.getElementById('dataInput').value;
            if (!rawData.trim()) {
                alert('è¯·è¾“å…¥æ•°æ®ï¼');
                return;
            }
            const processedData = processData(rawData);
            generateChart(processedData);
        }
    </script>
</body>

</html>